#!/usr/bin/env bash
set -euo pipefail

# thoughts-version - Check installed version against current repository version
# Compares the installed version from ~/.claude/VERSION with the current repo version

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

info() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

success() {
  echo -e "${GREEN}âœ“${NC} $1"
}

# Configuration
VERSION_FILE="$HOME/.claude/claude-code-dev-workflow-version"

# Check if VERSION file exists
if [ ! -f "$VERSION_FILE" ]; then
  error "Claude Code Workflow not installed"
  echo ""
  echo "Run the installer first:"
  echo "  cd /path/to/claude-code-dev-workflow"
  echo "  ./install.sh"
  exit 2
fi

# Read installed version info
INSTALLED_VERSION=""
INSTALLED_DATE=""
INSTALLED_COMMIT=""

while IFS='=' read -r key value; do
  case "$key" in
    version) INSTALLED_VERSION="$value" ;;
    installed) INSTALLED_DATE="$value" ;;
    commit) INSTALLED_COMMIT="$value" ;;
  esac
done < "$VERSION_FILE"

# Find the repository
find_repo() {
  # Check if we're currently in the repo
  if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    local root
    root=$(git rev-parse --show-toplevel)
    [ "$(basename "$root")" = "claude-code-dev-workflow" ] && echo "$root" && return
  fi

  # Search common locations
  local locations=("$HOME" "$HOME/projects" "$HOME/git" "$HOME/src")
  for dir in "${locations[@]}"; do
    [ -d "$dir/claude-code-dev-workflow/.git" ] && echo "$dir/claude-code-dev-workflow" && return
  done
}

REPO_PATH=$(find_repo)

# Display installed version
echo ""
echo -e "${BOLD}Installed Version:${NC}"
echo "  Version:   $INSTALLED_VERSION"
echo "  Installed: $INSTALLED_DATE"
echo "  Commit:    $INSTALLED_COMMIT"
echo ""

# If we found the repo, compare versions
if [ -n "$REPO_PATH" ]; then
  CURRENT_VERSION=$(cd "$REPO_PATH" && git describe --tags --always --dirty 2>/dev/null || echo "unknown")
  CURRENT_COMMIT=$(cd "$REPO_PATH" && git rev-parse HEAD 2>/dev/null || echo "unknown")

  echo -e "${BOLD}Repository Version:${NC}"
  echo "  Version:   $CURRENT_VERSION"
  echo "  Commit:    $CURRENT_COMMIT"
  echo "  Location:  $REPO_PATH"
  echo ""

  # Compare commits (source of truth)
  if [ "$INSTALLED_COMMIT" = "$CURRENT_COMMIT" ]; then
    [ "$INSTALLED_VERSION" = "$CURRENT_VERSION" ] && success "Up to date!" && exit 0
    warn "Same commit, but version differs (possibly local changes)"
    echo -e "\nConsider running: cd $REPO_PATH && ./install.sh"
    exit 1
  fi

  # Different commits = update available
  warn "Update available!"
  echo -e "\nTo update:\n  cd $REPO_PATH\n  git pull\n  ./install.sh"
  exit 1
else
  # Couldn't find repo
  warn "Repository not found in common locations"
  echo -e "\nTo check for updates manually:"
  echo -e "  cd /path/to/claude-code-dev-workflow\n  git pull\n  ./install.sh"
  echo -e "\nSearched in:"
  echo "  - $HOME/claude-code-dev-workflow"
  echo "  - $HOME/projects/claude-code-dev-workflow"
  echo "  - $HOME/git/claude-code-dev-workflow"
  echo "  - $HOME/src/claude-code-dev-workflow"
  exit 0
fi
